import sys
import json
import csv
import os

def is_standard_intent(intent, standard_intents):
    return intent in standard_intents

def is_standard_permission(permission, standard_permissions):
    return permission in standard_permissions

def convert_to_csv_format(name):
    name = name.lower().replace(".", "dot")
    return name

def load_standard_items(csv_file_path):
    standard_items = set()
    with open(csv_file_path, "r") as csv_file:
        csv_reader = csv.reader(csv_file)
        for row in csv_reader:
            standard_items.add(row[0])
            # print(row[0])
    return standard_items

if len(sys.argv) != 5:
    print("Usage: python intent_permission_extraction_seperated.py <input_json_path> <intents_csv_file_path> <permissions_csv_file_path> <output_folder_path>")
    sys.exit(1)

input_file_path = sys.argv[1]
intents_csv_file_path = sys.argv[2]
permissions_csv_file_path = sys.argv[3]
output_folder_path = sys.argv[4]

with open(input_file_path, "r") as file:
    data = json.load(file)

permissions = {}
intents = {}
standard_intents = load_standard_items(intents_csv_file_path)
standard_permissions = load_standard_items(permissions_csv_file_path)

for permission in data["usesPermissions"]:
    permission_name = convert_to_csv_format(permission["name"])
    if is_standard_permission(permission_name, standard_permissions):
        if permission_name not in permissions:
            permissions[permission_name] = 1
        else:
            permissions[permission_name] += 1

for activity in data["application"]["activities"]:
    for intent_filter in activity["intentFilters"]:
        for action in intent_filter.get("actions", []):
            action_name = convert_to_csv_format(action["name"])
            if is_standard_intent(action_name, standard_intents):
                if action_name not in intents:
                    intents[action_name] = 1
                else:
                    intents[action_name] += 1

for service in data["application"]["services"]:
    for intent_filter in service.get("intentFilters", []):
        for action in intent_filter.get("actions", []):
            action_name = convert_to_csv_format(action["name"])
            if is_standard_intent(action_name, standard_intents):
                if action_name not in intents:
                    intents[action_name] = 1
                else:
                    intents[action_name] += 1

for receiver in data["application"]["receivers"]:
    for intent_filter in receiver.get("intentFilters", []):
        for action in intent_filter.get("actions", []):
            action_name = convert_to_csv_format(action["name"])
            if is_standard_intent(action_name, standard_intents):
                if action_name not in intents:
                    intents[action_name] = 1
                else:
                    intents[action_name] += 1


output_data = {
    "permissions": permissions,
    "intents": intents
}

# Generate the output file name
input_file_name = os.path.basename(input_file_path)
output_file_name = os.path.splitext(input_file_name)[0] + ".json"

output_file_path = os.path.join(output_folder_path, output_file_name)

with open(output_file_path, "w") as output_file:
    json.dump(output_data, output_file, indent=2)

print(f"Generating output file at: {output_file_path}")