import os
import json
import csv
import argparse
from typing import List, Dict, Tuple


def load_headers(file_path: str) -> List[str]:
    headers = []
    with open(file_path, "r") as f:
        reader = csv.reader(f)
        for row in reader:
            if row:
                headers.append(row[0])
    headers = headers[:-2]
    return headers



def check_csv_files_exist(file_paths: List[str]) -> bool:
    for path in file_paths:
        if not os.path.exists(path):
            print(f"CSV file '{path}' does not exist.")
            return False
    return True

def vectorize_data(data: Dict[str, int], headers: List[str], use_count: bool = False) -> List[int]:
    vector = [0] * len(headers)
    for key, count in data.items():
        if key in headers:
            vector[headers.index(key)] = count if use_count else 1
    return vector



def process_files(input_dir: str) -> Tuple[List[int], List[int], List[int], List[int]]:
    intents_headers = load_headers(header_csv_files[0])
    permissions_headers = load_headers(header_csv_files[1])
    merged_headers = load_headers(header_csv_files[2])
    api_headers = load_headers(header_csv_files[3])

    api_files_dir = os.path.join(input_dir, "APIs")
    intent_permission_files_dir = os.path.join(input_dir, "IntentPermission")

    for json_file in os.listdir(api_files_dir):
        if json_file.endswith("_API.json"):
            json_file_path = os.path.join(api_files_dir, json_file)
            with open(json_file_path, "r") as file:
                api_data = json.load(file)
            api_vector = vectorize_data(api_data, api_headers, use_count=False)
            print(f"API Vector for {json_file}: {api_vector}")

    for json_file in os.listdir(intent_permission_files_dir):
        if json_file.endswith("_IntentPerms.json"):
            json_file_path = os.path.join(intent_permission_files_dir, json_file)
            with open(json_file_path, "r") as file:
                intent_permission_data = json.load(file)
            intents_vector = vectorize_data(intent_permission_data["intents"], intents_headers)
            print(f"Intents Vector for {json_file}: {intents_vector}")

            permissions_vector = vectorize_data(intent_permission_data["permissions"], permissions_headers)
            print(f"Permissions Vector for {json_file}: {permissions_vector}")

            merged_vector = vectorize_data({**intent_permission_data["intents"], **intent_permission_data["permissions"]}, merged_headers)
            print(f"Merged Vector for {json_file}: {merged_vector}")


if __name__ == "__main__":
    # You can replace these paths with the paths to your CSV files
    header_csv_files = [
        "ChimeraDataset\Headers\ChimeraDatasetIntent_headers.csv",
        "ChimeraDataset\Headers\ChimeraDatasetPermission_headers.csv",
        "ChimeraDataset\Headers\ChimeraDatasetMerged_headers.csv",
        "CICMalDroidDataset\MobFS_APIs_heads_mini.csv"
    ]

    if not check_csv_files_exist(header_csv_files):
        print("Please Build the CSV files first.")
        exit(1)

    header_lists = [load_headers(csv_file) for csv_file in header_csv_files]

    parser = argparse.ArgumentParser(
        description="Generate vectorized arrays from JSON files.")
    parser.add_argument(
        "-i", "--input_dir", help="Path to the input directory", type=str, required=True)

    args = parser.parse_args()

    process_files(args.input_dir)
