# AndroidMalwareSleuth: Deobfuscation & ML-based Detection

# Tensorflow-Serving with Docker
# INSTALLATION
## 1. Install Docker
## 2. Pull the rakshithbabu111/android_malware_4_classifier_tf_s:v1.0 image
```bash
docker pull rakshithbabu111/android_malware_4_classifier_tf_s:v1.0
```
## 3. Run the docker image
```bash
docker run -p 8501:8501 rakshithbabu111/android_malware_4_classifier_tf_s:v1.0
```
## 4. Auto Build and test the model directly 

```bash
python Train_RandomForest\docker_api.py
-----
{
    "outputs": [
        [
            0.793332696
        ]
    ]
}
{
    "outputs": [
        [
            0.0300000031
        ]
    ]
}
{
    "outputs": [
        [
            0.0866666511
        ]
    ]
}
{
    "outputs": [
        [
            0.0566666722
        ]
    ]
}
| Dataset                               | Confidence Score | Confidence Percentage |
| --------------------------------------| -----------------| ----------------------|
| mobfs                                 | 0.79          | Malware Confidence @ 79.33% |
| chimera_intents                       | 0.03          | Benign Confidence @ 97.00% |
| chimera_permissions                   | 0.09          | Benign Confidence @ 91.33% |
| chimera_merged                        | 0.06          | Benign Confidence @ 94.33% |

Final Class: Benign Confidence @ 75.83% (Score: 0.24)
```
5. To build your own model and test it
   - Choose a model from the [models](Models) folder
   - modify the dockerfile
   - Create the image by running the dockerfile
```bash
docker build -t your_image_name .
```
  - Run the docker image
```bash
docker run -p 8500:8500 -p 8501:8501 -t your_image_name
```

# MAIN SCRIPTS

- [ ] INIT DOCKERS (MOBFS,ML MODELS)
- [ ] SHOW STATUS OF DOCKERS
- [ ] ACCEPT FOLDER OF APK FILES
- [ ] (OPTIONAL) SHOW OPTIONS OF POSSIBLE MODELS TO CHOOSE FROM
- [ ] PASS APK FILES TO FEATURE EXTRACTION SCRIPT
- [ ] SIMULATANEOSLY PASS APK FILES THE INTENT AND PERMISSION EXTRACTOR
- [ ] FILTER OUT UNNECESSARY DATA FROM THE EXTRACTED DATA
- [ ] SAVE THE COUNTS OF APIS
- [ ] BUILD A BODY OF EXTRACTED INTENT,PERMISSION AND API
- [ ] SERVER THE DATA TO THE MODEL
- [ ] WAIT FOR THE MODEL TO RETURN THE RESULT
- [ ] AGGREGATE THE RESULTS BY ADDING THE WEIGHTS OF EACH CATEGORY
- [ ] OUTPUT THE RESULT

# TO DO LIST

- [x] `malware det\only_true_drebin.csv` - Tested Drebin Dataset for training (without duplicates data)
- [x] Tested docker with [MobFS](https://github.com/MobSF/Mobile-Security-Framework-MobSF)
- [x] Split Chimaera dataset into permission and intent datasets


- [x] Build Script to extract intent and permission from apk and save it in csv file
- [x] Modify MobFS to extract Only apis
- [x] Save the extracted apis in csv file
- [x] Create a script to convert MobFS apis to CICMalDroid apis
- [x] Filter out the apis,permisson,intents that are not in CICMalDroid dataset and the ones that are not in MobFS dataset
- [x] Create a script to build a body of extracted apis, permission and intent so it can be sent to the model for evaluation
- [x] Pass new input data (APK) to MobSF for API extraction
- [x] Build tensorflow randomforest model using tensorflow serving
- [x] Deploy model
- [ ] Integrate 
- [ ] Test 

- [x] Prepare dataset for training

  - [x] Build a script to extract api's name from the scan report( CICMalDroid dataset)
  - [x] save all metadata in csv file for future use (CICMalDroid dataset)
  - [x] Modify Chimaera dataset to only contain permission and intent
  - [x] save all metadata in csv file for future use (Chimaera dataset)
  - [x] Build a dataset using the header of the CICMalDroid dataset and the extracted apis from the CICMalDroid dataset

# Additional Tasks


  - [x] Extract sensitive APIs from CICMalDroid dataset analysis
  - [ ] Create a new dataset using the extracted sensitive APIs

  
### It seems that we have encountered <35 sensitive APIs in the CICMalDroid dataset which when compared to the based MobSF API list which has about 51. This is because the MobSF API list is based on the some of the latest ANDROID API's while the CICMalDroid have used a different approach to extract the sensitive APIs. 
## Soon we will be building a new dataset using the MobSF API list on CICMalDroid dataset APKs
- [ ] Build a new dataset using the MobSF API list on CICMalDroid dataset APKs
<s>
- [ ] Update MobSF's predefined API list (yaml) with the new sensitive APIs  <br>
- [ ] Ensure that MobSF scans and extracts the new sensitive APIs during analysis <br>
- [ ] Expand sensitive API list for MobSF
</s>

## Training and testing information

#### Tests to be performed:

- [x] Test 1: Train model on CICMalDroid dataset @ [here](https://github.com/rakshith111/AndroidMalwareSleuth/blob/main/datasetanalysis.md#dataset---cicmaldroiddatasetcicmaldroidxmobfsdatasetcsv)
- [x] Test 2: Train model on CICMalDroid dataset seperate and Chimaera dataset for permission and Intent (PERMISSION + INTENT i.e MERGED) @ [here](https://github.com/rakshith111/AndroidMalwareSleuth/blob/main/datasetanalysis.md#dataset-chimeradatasetcleanedchimeradatasetmerged_cleanedcsv)
- [x] Test 3: Train model on Chimaera dataset for permission and Intent ( PERMISSION + INTENT) (ALL SEPERATED) @ [here](https://github.com/rakshith111/AndroidMalwareSleuth/blob/main/datasetanalysis.md#dataset-chimeradatasetcleanedchimeradatasetintent_cleanedcsv)

#### This was done to check if there is any improvement in the accuracy of the model when the dataset is seperated or not

## Final classification

- Count the number of apis extracted per category and assign a weight to each category this will be used to calculate the final classification and the amount of attention to be given to each category

# References and Credits

- [MobFS](https://github.com/MobSF/Mobile-Security-Framework-MobSF) For API extraction
- [Chimaera](https://ieee-dataport.org/open-access/malware-analysis-datasets-chimera-multimodal-deep-learning-android-malware-detection)
- [CICMalDroid](https://www.unb.ca/cic/datasets/maldroid-2020.html)
- [Drebin](https://www.kaggle.com/datasets/shashwatwork/android-malware-dataset-for-machine-learning) Modified Drebin dataset for suitable training
- 
```
    Samaneh Mahdavifar, Andi Fitriah Abdul Kadir, Rasool Fatemi, Dima Alhadidi, Ali A. Ghorbani; Dynamic Android Malware Category Classification using Semi-Supervised Deep Learning, The 18th IEEE International Conference on Dependable, Autonomic, and Secure Computing (DASC), Aug. 17-24, 2020.

    Samaneh Mahdavifar, Dima Alhadidi, and Ali A. Ghorbani (2022). Effective and Efficient Hybrid Android Malware Classification Using Pseudo-Label Stacked Auto-Encoder, Journal of Network and Systems Management 30 (1), 1-34
```
------------------
## Contributing

Contributions are welcome! If you find any bugs or have suggestions for new features, please open an issue or submit a pull request.

## License
Although this is under GPL-3.0 license, we kindly request you to refrain from using this code for any commercial purposes. This is a research project and we would like to keep it that way. Thank you for understanding.